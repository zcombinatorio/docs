---
title: "Confirm Purchase Transaction"
description: "POST /ico/:tokenAddress/purchase/confirm - Submit signed purchase transaction to complete token purchase"
---

## Overview

Receives a user-signed purchase transaction from [Prepare Purchase](/api-reference/ico/purchase-prepare), validates it, adds the escrow signature, and submits the complete transaction to the Solana blockchain.

<CodeGroup>

```bash curl
curl -X POST "https://api.zcombinator.io/ico/EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v/purchase/confirm" \
  -H "Content-Type: application/json" \
  -H "x-api-key: YOUR_API_KEY" \
  -d '{
    "signedTransaction": "AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEDAhQn...",
    "requestId": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
  }'
```

```javascript fetch
const tokenAddress = "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v";

const response = await fetch(
  `https://api.zcombinator.io/ico/${tokenAddress}/purchase/confirm`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': 'YOUR_API_KEY'
    },
    body: JSON.stringify({
      signedTransaction: signedTransactionBase64,
      requestId: requestId
    })
  }
);

const result = await response.json();
```

```python requests
import requests

token_address = "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"

data = {
    "signedTransaction": signed_transaction_base64,
    "requestId": request_id
}

response = requests.post(
    f'https://api.zcombinator.io/ico/{token_address}/purchase/confirm',
    json=data,
    headers={
        'Content-Type': 'application/json',
        'x-api-key': 'YOUR_API_KEY'
    }
)

result = response.json()
```

</CodeGroup>

## Authentication

<ParamField header="x-api-key" type="string" required>
  API key for authentication
</ParamField>

## URL Parameters

<ParamField path="tokenAddress" type="string" required>
  The Solana token mint address of the ICO
</ParamField>

## Request Parameters

<ParamField body="signedTransaction" type="string" required>
  Base64 encoded transaction signed by the user's wallet
</ParamField>

<ParamField body="requestId" type="string" required>
  Unique request identifier returned from [Prepare Purchase](/api-reference/ico/purchase-prepare)
</ParamField>

## Response

<ResponseField name="success" type="boolean">
  Indicates if the purchase was successful
</ResponseField>

<ResponseField name="message" type="string">
  Human-readable success message
</ResponseField>

<ResponseField name="signature" type="string">
  The Solana transaction signature
</ResponseField>

<ResponseField name="tokensToVault" type="string">
  Number of tokens sent to vault (for staking updates)
</ResponseField>

### Success Response

```json
{
  "success": true,
  "message": "Purchase recorded successfully",
  "signature": "5VfYiDvQMBSWxKJLa9NLPQ1x3...",
  "tokensToVault": "25000000000000"
}
```

## Error Responses

<AccordionGroup>
  <Accordion title="401 - Unauthorized">
    ```json
    {
      "error": "Unauthorized - Invalid or missing API key"
    }
    ```
  </Accordion>

  <Accordion title="400 - Missing Parameters">
    ```json
    {
      "error": "Missing required fields: signedTransaction and requestId"
    }
    ```
  </Accordion>

  <Accordion title="400 - Invalid Token Address">
    ```json
    {
      "error": "Invalid token address format"
    }
    ```
  </Accordion>

  <Accordion title="400 - Request Not Found">
    ```json
    {
      "error": "Purchase request not found or expired. Please call /purchase/prepare first."
    }
    ```
  </Accordion>

  <Accordion title="400 - Token Address Mismatch">
    ```json
    {
      "error": "Token address mismatch"
    }
    ```
  </Accordion>

  <Accordion title="400 - Request Expired">
    ```json
    {
      "error": "Purchase request expired. Please create a new request."
    }
    ```
  </Accordion>

  <Accordion title="400 - Invalid Transaction">
    ```json
    {
      "error": "Invalid transaction format"
    }
    ```
  </Accordion>

  <Accordion title="400 - Sale Not Active">
    ```json
    {
      "error": "ICO sale is not active. Purchasing is only allowed during active sales.",
      "errorCode": "SALE_NOT_ACTIVE",
      "currentStatus": "finalized"
    }
    ```
  </Accordion>

  <Accordion title="400 - Invalid Blockhash">
    ```json
    {
      "error": "Invalid transaction: blockhash is expired. Please create a new transaction."
    }
    ```
  </Accordion>

  <Accordion title="400 - Invalid Fee Payer">
    ```json
    {
      "error": "Invalid transaction: fee payer must be buyer wallet"
    }
    ```
  </Accordion>

  <Accordion title="400 - Not Signed">
    ```json
    {
      "error": "Transaction not signed by user wallet"
    }
    ```
  </Accordion>

  <Accordion title="400 - Invalid Signature">
    ```json
    {
      "error": "Transaction verification failed: Invalid user wallet signature"
    }
    ```
  </Accordion>

  <Accordion title="400 - Transaction Tampered">
    ```json
    {
      "error": "Transaction verification failed: transaction has been modified",
      "details": "Transaction structure does not match the original unsigned transaction"
    }
    ```
  </Accordion>

  <Accordion title="400 - Exceeds Available Tokens">
    ```json
    {
      "error": "Purchase amount exceeds available tokens. Available: 1000000, Requested: 5000000",
      "errorCode": "EXCEEDS_AVAILABLE_TOKENS",
      "tokensAvailable": "1000000",
      "tokensRequested": "5000000"
    }
    ```
  </Accordion>

  <Accordion title="404 - ICO Not Found">
    ```json
    {
      "error": "ICO sale not found or not properly configured"
    }
    ```
  </Accordion>

  <Accordion title="500 - Transaction Submission Failed">
    ```json
    {
      "error": "Failed to submit transaction: [error message]"
    }
    ```
  </Accordion>

  <Accordion title="500 - Confirmation Failed">
    ```json
    {
      "error": "Transaction submitted but confirmation failed: [signature]. [error message]"
    }
    ```
  </Accordion>
</AccordionGroup>

## Security Validations

The server performs extensive security checks before processing:

<Steps>
<Step title="API Key Validation">
Verifies the request includes a valid API key
</Step>

<Step title="Request Lookup">
Retrieves stored transaction data using `requestId`
</Step>

<Step title="Expiration Check">
Ensures the request is less than 10 minutes old
</Step>

<Step title="Sale Status">
Confirms the ICO sale is still `active` (not `finalized`)
</Step>

<Step title="Blockhash Validation">
Verifies the transaction blockhash is still valid
</Step>

<Step title="Fee Payer Check">
Confirms the fee payer matches the buyer wallet
</Step>

<Step title="Signature Verification">
Validates the user's cryptographic signature
</Step>

<Step title="Transaction Integrity">
Compares SHA-256 hash to detect any tampering
</Step>

<Step title="Overselling Protection">
Verifies tokens_sold + purchase does not exceed total_tokens_for_sale
</Step>
</Steps>

## Process Flow

<Steps>
<Step title="Validate Request">
Check API key, request ID, and token address match
</Step>

<Step title="Acquire Lock">
Obtain mutex lock for this token to prevent race conditions
</Step>

<Step title="Security Checks">
Run all validation steps above
</Step>

<Step title="Add Escrow Signature">
Sign transaction with escrow keypair
</Step>

<Step title="Submit Transaction">
Send fully-signed transaction to Solana blockchain
</Step>

<Step title="Wait for Confirmation">
Monitor until transaction is confirmed
</Step>

<Step title="Record Purchase">
Save purchase details to database
</Step>

<Step title="Cleanup">
Remove temporary request data
</Step>
</Steps>

## Rate Limiting

This endpoint is subject to rate limiting:
- **30 requests per IP** per 1-minute window
- Returns HTTP 429 when limit exceeded

## Transaction Verification

You can verify successful purchases on Solana explorers:

```
https://solscan.io/tx/{signature}
```

## Integration Notes

<Warning>
**Do not submit to blockchain directly!** The transaction requires the escrow signature which only the server can provide. Always submit through this endpoint.
</Warning>

<Tip>
If the purchase fails due to network issues (not validation errors), you may retry with the same `requestId` as long as it hasn't expired.
</Tip>

## Next Steps

After confirming a purchase:

1. **Verify on-chain**: Check the transaction signature on Solana explorer
2. **View history**: [Get Purchase History](/api-reference/ico/purchase-history)
3. **Check claimable**: [Get Claim Info](/api-reference/ico/claim-info)
