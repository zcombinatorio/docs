---
title: "Prepare Purchase Transaction"
description: "POST /ico/:tokenAddress/purchase/prepare - Prepare an unsigned purchase transaction"
---

## Overview

Prepares an unsigned transaction for purchasing tokens during an active ICO sale. The user must sign this transaction with their wallet, then submit it to the [Confirm Purchase](/api-reference/ico/purchase-confirm) endpoint.

<CodeGroup>

```bash curl
curl -X POST "https://api.zcombinator.io/ico/EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v/purchase/prepare" \
  -H "Content-Type: application/json" \
  -H "x-api-key: YOUR_API_KEY" \
  -d '{
    "wallet": "9WzDXwBbmkg8ZTbNMqUxvQRAyrZzDsGYdLVL9zYtAWWM",
    "solAmount": "1000000000"
  }'
```

```javascript fetch
const tokenAddress = "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v";

const response = await fetch(
  `https://api.zcombinator.io/ico/${tokenAddress}/purchase/prepare`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': 'YOUR_API_KEY'
    },
    body: JSON.stringify({
      wallet: "9WzDXwBbmkg8ZTbNMqUxvQRAyrZzDsGYdLVL9zYtAWWM",
      solAmount: "1000000000"
    })
  }
);

const result = await response.json();
```

```python requests
import requests

token_address = "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"

data = {
    "wallet": "9WzDXwBbmkg8ZTbNMqUxvQRAyrZzDsGYdLVL9zYtAWWM",
    "solAmount": "1000000000"
}

response = requests.post(
    f'https://api.zcombinator.io/ico/{token_address}/purchase/prepare',
    json=data,
    headers={
        'Content-Type': 'application/json',
        'x-api-key': 'YOUR_API_KEY'
    }
)

result = response.json()
```

</CodeGroup>

## Authentication

<ParamField header="x-api-key" type="string" required>
  API key for authentication
</ParamField>

## URL Parameters

<ParamField path="tokenAddress" type="string" required>
  The Solana token mint address of the ICO
</ParamField>

## Request Parameters

<ParamField body="wallet" type="string" required>
  Base58 encoded public key of the buyer's wallet
</ParamField>

<ParamField body="solAmount" type="string" required>
  Amount of SOL to spend in lamports (1 SOL = 1,000,000,000 lamports)
</ParamField>

## Response

<ResponseField name="transaction" type="string">
  Base64 encoded unsigned transaction for the user to sign
</ResponseField>

<ResponseField name="requestId" type="string">
  Unique identifier for this purchase request (required for confirmation)
</ResponseField>

<ResponseField name="icoSaleId" type="number">
  ID of the ICO sale
</ResponseField>

<ResponseField name="tokensBought" type="string">
  Total number of tokens the user will receive
</ResponseField>

<ResponseField name="tokensToVault" type="string">
  Tokens that will be sent to vault immediately (50%)
</ResponseField>

<ResponseField name="tokensClaimable" type="string">
  Tokens that will be claimable after sale finalization (50%)
</ResponseField>

<ResponseField name="escrowPubKey" type="string">
  Public key of the escrow account
</ResponseField>

<ResponseField name="actualSolAmount" type="string">
  Actual SOL amount required (may be less than requested if near cap)
</ResponseField>

### Success Response

```json
{
  "transaction": "AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEDAhQn...",
  "requestId": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6",
  "icoSaleId": 1,
  "tokensBought": "50000000000000",
  "tokensToVault": "25000000000000",
  "tokensClaimable": "25000000000000",
  "escrowPubKey": "7nxQB6p4qE7V8L5mD...",
  "actualSolAmount": "1000000000"
}
```

## Error Responses

<AccordionGroup>
  <Accordion title="401 - Unauthorized">
    ```json
    {
      "error": "Unauthorized - Invalid or missing API key"
    }
    ```
  </Accordion>

  <Accordion title="400 - Missing Parameters">
    ```json
    {
      "error": "Wallet and solAmount are required"
    }
    ```
  </Accordion>

  <Accordion title="400 - Invalid Token Address">
    ```json
    {
      "error": "Invalid token address format"
    }
    ```
  </Accordion>

  <Accordion title="400 - Invalid Wallet Address">
    ```json
    {
      "error": "Invalid wallet address format"
    }
    ```
  </Accordion>

  <Accordion title="400 - Invalid SOL Amount">
    ```json
    {
      "error": "Invalid SOL amount"
    }
    ```
  </Accordion>

  <Accordion title="500 - Server Error">
    ```json
    {
      "error": "Failed to prepare purchase"
    }
    ```
  </Accordion>
</AccordionGroup>

## Transaction Details

The prepared transaction contains two instructions:

<Steps>
<Step title="SOL Transfer">
Transfers SOL from the buyer's wallet to the escrow account
</Step>

<Step title="Token Transfer">
Transfers 50% of purchased tokens from escrow to the vault
</Step>
</Steps>

## Purchase Flow

<Steps>
<Step title="Prepare Transaction">
Call this endpoint to get an unsigned transaction
</Step>

<Step title="User Signs">
Present the transaction to the user's wallet for signing
</Step>

<Step title="Confirm Purchase">
Submit the signed transaction to [Confirm Purchase](/api-reference/ico/purchase-confirm) with the `requestId`
</Step>

<Step title="Transaction Submitted">
Server adds escrow signature and submits to blockchain
</Step>
</Steps>

## Overselling Protection

The server implements several protections against overselling:

1. **Mutex Lock**: Per-token lock prevents race conditions
2. **Database Check**: Verifies `tokens_sold + purchase <= total_tokens_for_sale`
3. **Amount Adjustment**: May return lower `actualSolAmount` if near cap

<Warning>
The `actualSolAmount` may be less than requested `solAmount` if the purchase would exceed remaining tokens. Always check this value before showing to users.
</Warning>

## Request Expiration

<Note>
The `requestId` expires after **10 minutes**. If the user doesn't sign and confirm within this window, they must call this endpoint again to get a fresh transaction.
</Note>

## Rate Limiting

This endpoint is subject to rate limiting:
- **30 requests per IP** per 1-minute window
- Returns HTTP 429 when limit exceeded

## Integration Example

```javascript
// 1. Prepare the transaction
const prepareResponse = await fetch(
  `https://api.zcombinator.io/ico/${tokenAddress}/purchase/prepare`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey
    },
    body: JSON.stringify({
      wallet: walletPublicKey.toBase58(),
      solAmount: (1 * 1e9).toString() // 1 SOL
    })
  }
);
const { transaction, requestId } = await prepareResponse.json();

// 2. Decode and sign the transaction
const txBuffer = Buffer.from(transaction, 'base64');
const tx = VersionedTransaction.deserialize(txBuffer);
const signedTx = await wallet.signTransaction(tx);

// 3. Confirm the purchase
const confirmResponse = await fetch(
  `https://api.zcombinator.io/ico/${tokenAddress}/purchase/confirm`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey
    },
    body: JSON.stringify({
      signedTransaction: Buffer.from(signedTx.serialize()).toString('base64'),
      requestId
    })
  }
);
```

## Next Steps

After preparing a purchase:

1. **Sign transaction**: Have user sign with their wallet
2. **Confirm purchase**: [Confirm Purchase](/api-reference/ico/purchase-confirm)
3. **Check history**: [Get Purchase History](/api-reference/ico/purchase-history)
